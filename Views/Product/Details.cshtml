@using System.Collections.Generic
@using DoAn_web.Models
@model DoAn_web.Models.Product
@{
    ViewBag.Title = Model.ProductName;
    Layout = "~/Views/Shared/_HomeLayout.cshtml";
    var combo = ViewBag.ComboAccessories as List<Product>;
    var related = ViewBag.RelatedProducts as List<DoAn_web.Models.Product>;
}
<link href="~/Content/style_K/Style_TrangCuThe.css" rel="stylesheet" />

<div class="detail-flex-container">

    <div class="column-left">
        <div class="product-image-box">
            <img src="@Url.Content(Model.ProductImage)" alt="@Model.ProductName" class="product-detail-image" />
        </div>
    </div>

    <div class="column-right">

        <h1 class="product-name">@Model.ProductName</h1>

        <p class="product-price">@String.Format("{0:N0}", Model.ProductPrice) đ</p>

        <hr style="border-top: 1px solid #eee;" />



        @if (Model.Quantity > 0)
        {
            <div style="background-color: #dff0d8; color: #3c763d; border: 1px solid #d6e9c6; padding: 10px; border-radius: 4px; margin-bottom: 20px; display: flex; justify-content: space-between;">
                <span> Còn hàng: <span style="font-weight: bold;">@Model.Quantity</span> sản phẩm</span>
                <span style="font-size: 12px; color: #666;">Giới hạn mua tối đa: @Model.Quantity</span>
            </div>

            using (Html.BeginForm("AddToCart", "Cart", FormMethod.Post))
            {
                @Html.Hidden("productID", Model.ProductID)

                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                    <label style="margin-right: 15px; font-weight: bold;">Số lượng:</label>

                    <input type="number"
                           name="quantity"
                           value="1"
                           min="1"
                           max="@Model.Quantity" @* Thiết lập giới hạn tối đa *@
                           style="padding: 8px; border: 1px solid #ccc; width: 80px; margin-right: 20px;"
                           required />

                    <button type="submit" style="background-color: #5cb85c; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-size: 18px; cursor: pointer;">
                        Thêm vào giỏ hàng
                    </button>
                </div>
            }
        }
        else
        {
            <div style="background-color: #f2dede; color: #a94442; border: 1px solid #ebccd1; padding: 10px; border-radius: 4px; margin-bottom: 20px;">
                **Sản phẩm này tạm thời hết hàng!**
            </div>

            <button type="button" disabled style="background-color: #ccc; color: #666; border: none; padding: 10px 20px; border-radius: 4px; font-size: 18px; cursor: not-allowed;">
                Đã hết hàng
            </button>
        }

        <hr style="border-top: 1px solid #eee;" />

        <h5 style="margin-top: 30px; font-weight: bold;">Mô tả chi tiết</h5>
        <div style="line-height: 1.6; color: #555;">
            <p>@Model.ProductDecription</p>
        </div>
    </div>
</div>
@if (combo != null && combo.Any())
{
    var accessoryCount = combo.Count;
    decimal comboTotal = combo.Sum(a => a.ProductPrice);   // nếu ProductPrice là decimal

    <form action="@Url.Action("AddComboToCart", "Cart")" method="post">
        @* hidden cho sản phẩm chính *@
        @Html.Hidden("productID", Model.ProductID)

        @* hidden cho từng phụ kiện *@
        @foreach (var a in combo)
        {
            @Html.Hidden("accessoryIds", a.ProductID)
        }

        <div class="combo-wrapper">
            <h3 class="combo-title">Mua kèm giá sốc</h3>

            <div class="combo-inner">
                <!-- Sản phẩm chính bên trái -->
                <div class="combo-main-product">
                    <img src="@Url.Content(Model.ProductImage)" alt="@Model.ProductName" />
                    <div class="combo-main-name">@Model.ProductName</div>
                    <div class="combo-main-price">
                        @String.Format("{0:N0}", Model.ProductPrice) đ
                    </div>
                </div>

                <div class="combo-plus">+</div>

                <!-- Các phụ kiện ở giữa -->
                <div class="combo-items">
                    @foreach (var a in combo)
                    {
                        <div class="combo-item">
                            <a href="@Url.Action("Details", "Product", new { id = a.ProductID })"
                               style="text-decoration:none; color:inherit;">
                                <img src="@Url.Content(a.ProductImage)" alt="@a.ProductName" />
                                <div class="combo-item-name">@a.ProductName</div>

                                <div class="combo-item-price-label">Giá bán:</div>
                                <div class="combo-item-price">
                                    @String.Format("{0:N0}", a.ProductPrice) đ
                                </div>
                            </a>
                        </div>
                    }
                </div>

                <!-- Tổng tiền + nút mua combo bên phải -->
                <div class="combo-summary">
                    <div class="combo-summary-title">Tổng giá 3 phụ kiện</div>
                    <div class="combo-summary-price">
                        @String.Format("{0:N0}", comboTotal) đ
                    </div>
                    <div class="combo-summary-count">
                        Đã chọn: @accessoryCount sản phẩm
                    </div>

                    <button type="submit" class="combo-summary-button">
                        Mua combo @(@accessoryCount + 1) sản phẩm
                    </button>
                </div>
            </div>
        </div>
    </form>
}



@if (related != null && related.Any())
{
    <div class="related-products-wrapper">
        <h3 class="related-title">Sản phẩm tương tự</h3>

        <div class="related-list">
            @foreach (var p in related)
            {
                <div class="related-item">
                    <a href="@Url.Action("Details", "Product", new { id = p.ProductID })"
                       style="text-decoration:none; color:inherit;">
                        <img src="@Url.Content(p.ProductImage)" alt="@p.ProductName" />

                        <div class="related-item-name">
                            @p.ProductName
                        </div>

                        <div class="related-item-price">
                            @String.Format("{0:N0}", p.ProductPrice) đ
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>
}